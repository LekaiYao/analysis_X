# analysis_X

This is used to analysis X(3872) in ppRef and PbPb. With MC and data ntuple samples after `Bfinder`, `analysis_X`
could achieve the functions of `flatten`, `plot`, `correlation`, `select`, `optimization`, `BDT`, `fit`

---
## Project Structure & Description


| File/Folder             | Description                                                  |
|-------------------------|--------------------------------------------------------------|
| `./correlation/` | Calculate the correlation matrix |
| `correlation.py` | main python file for correlation calculation. |
| `./fit/` | Contains different fit methods corresponding to different situations |
| `fit_data.C` | fit to data (after cuts) |
| `fit_data_methodN.C` | different fitting methods to calculate systematic uncertainties |
| `fit_MC_PSI.C,fit_MC_X.C` | fit to MC |
| `fit_PSI_fsfb.C,fit_X_fsfb.C` | rough fit to data to get scaling factors in optimization|
| `./optimization/` | Optimize single variables |
| `draw_cut.C` | draw the mass distribution of data after cuts |
| `input.txt` | define the variables and their region to optimize |
| `new_optimization_template.C` | use X to optimize, and draw both X and PSI |
| `optimization_template.C` | use PSI to optimize |
| `new_Run.sh` | script to run `new_optimization_template.C` |
| `Run.sh` | script to run `optimization_template.C` |
| `./scan/` | Scan all variables, plot the data and MC distributions in auto regions, plot specific variable distributions |
| `plot_template.C` | template for scan and plot the data and MC distributions in auto regions |
| `plot_var.C,plot_var_zoom.C` | plot specific variable distributions from sideband and MC |
| `input.txt` | variable list for scan |
| `scan.sh` | script for scan |
| `./selection/` | flatten, remove nan entry, selection |
| `remove_nan.C` | remove nan entry |
| `select.C` | selection |
| `analysis/` | flatten and pre-selection |
| `analysis_xxx.C`,`analysis_xxx.h` | from `TTree::MakeClass`, pre-selection and instruction to run is in .C |
| `gen_code.py` | generate the definition we need for .C from .h |
| `./TMVA/` | Train BDT, Check and Apply; Check part is being developed now |
| `new_TMVA_BDTs.py,TMVA_BDTs.py` | train BDT, new one is modified for this project |
| `apply_BDT.py` | apply the training result |
| `*check*` | being developed |

---

## Environment
The codes are based on root version `6.30.04` (at pauli). Some errors might take place when running BDT training at curie.

## How to Use the Project
For the codes not introduced below, you could simply run them by `python3` to .py files, `root -l` to .C files.  
When fit or selection is needed, you could go into the corresponding folder and find the codes you need.

### How to Flatten Bfinder Ntuples and Make Selections
1. Create `analysis_xxx.C,analysis_xxx.h`
    - Run `root -l \PathToNtuples\NTUPLE.root`
    - cd the directory and find the TTree `TREE` which stores the information
    - Run `TREE->MakeClass("analysis_xxx")`, then .C and .h files are created
2. Run `python3 gen_code.txt analysis_xxx.h > xxx.txt`
    - Get the definitions you need of all variables
3. Copy and paste them into `analysis_xxx.C`, add pre-selection cuts
4. Run the codes according to the instruction in `analysis_xxx.C`(automatically generated by `MakeClass`)
5. If you want to remove nan or make selections, Run `root -l remove_nan.C` or `root -l select.C`

### How to Scan Variables
1. Edit `input.txt` with names of variables to be scanned
2. Run `./scan.sh` to scan variables with auto regions

### How to Optimize Variables
1. Define sideband region (by eye or fitting MC) and Produce sideband samples by selections
2. Fit to get scaling factors
3. Run `./new_Run.sh`
    - The FOM vs variables plots and summary of optimal cuts are saved in the path you defined in `new_optimization_template.C`
4. (Optional) Run `draw_cut.C`
    - The performance of optimal cuts are plotted

### How to Run BDT

1. Define sideband region (by eye or fitting MC) and Produce sideband samples by selections
2. Run `python3 new_TMVA_BDTs.py YOURTESTVERSION`
    - Trains model using preprocessed data
3. Run `python3 apply_BDT.py`
    - Apply the BDT results to data/MC and Generate new root files with `BDT_score`
4. Optimize `BDT_score`
5. Use optimal `BDT_score` cut in selection and Search for signal in data

